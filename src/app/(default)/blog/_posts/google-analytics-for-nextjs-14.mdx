---
isPublished: false
publishedOn: "2024-05-01"
updatedOn: "2024-07-24"
title: Google Analytics (GA4) for Next.js 14
subtitle: Add Google Analytics to a Next.js site with a GDPR-compliant opt-in cookie banner.
excerpt: I couldn't find a clean GDPR compliant implementation of Google Analytics (GA4) for Next.js 14 single page apps, so here it is.
tags:
  - Google Analytics
  - Next.js
---

# How to Add Google Analytics (GA4) to a Next.js 14 Website?

The requirements are clear, we want to add Google Analytics GA4 to a Next.js 14 (App direcotry website).
We want to make sure that the following requirements are met:

- Track page views across every URL not just when page initially loads
- Only set tracking cookie if user consents to tracking
- Cookie banner does not flicker while stored cookie state is being loaded from local storage.

```jsx
// components/google-analytics.tsx
'use client';

import Script from 'next/script'
import { useEffect } from "react";
import {usePathname, useSearchParams} from 'next/navigation'

export default function GoogleAnalytics({GA_MEASUREMENT_ID} : {GA_MEASUREMENT_ID : string}){

    const pathname = usePathname()
    const searchParams = useSearchParams()

    useEffect(() => {
        const url = pathname + searchParams.toString();

        if (typeof window !== 'undefined' && window.gtag) {
            window.gtag('config', GA_MEASUREMENT_ID, {
                page_path: url,
            });
        }
    }, [pathname, searchParams, GA_MEASUREMENT_ID]);

    return (
        <>
            <Script strategy="afterInteractive"
                src={`https://www.googletagmanager.com/gtag/js?id=${GA_MEASUREMENT_ID}`}/>

            <Script id='google-analytics' strategy="afterInteractive"
                dangerouslySetInnerHTML={{
                __html: `
                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                gtag('js', new Date());

                gtag('consent', 'default', {
                    'analytics_storage': 'denied'
                });

                gtag('config', '${GA_MEASUREMENT_ID}', {
                    page_path: window.location.pathname,
                });
                `,
                }}
            />
        </>
)}
```

```jsx
// components/layout.tsx
import GoogleAnalytics from "@/components/google-analytics";
import CookieBanner from "@/components/cookie-banner";
import React, { Suspense } from "react";

// Add Google Analytics and Cookie Banner to the root layout
export default function RootLayout({ children }) {
  return (
    <html lang="en">
      <Suspense fallback={null}>
        <GoogleAnalytics GA_MEASUREMENT_ID="G-*********" />
      </Suspense>
      <body>{children}</body>
      <CookieBanner />
    </html>
  );
}
```

```jsx
// components/cookie-banner.tsx
"use client";

import { useState, useEffect } from "react";
import { getLocalStorage, setLocalStorage } from "@/lib/storage-helper";
import { Button } from "./ui/button";
import Image from "next/image";

export default function CookieBanner() {
  const [cookieConsent, setCookieConsent] = useState(null);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    const storedCookieConsent = getLocalStorage("mot_cookie_consent", null);
    console.log("Cookie Consent retrieved from storage: ", storedCookieConsent);
    setCookieConsent(storedCookieConsent);
    setIsLoading(false);
  }, []);

  useEffect(() => {
    if (cookieConsent !== null) {
      setLocalStorage("mot_cookie_consent", cookieConsent);
    }

    const newValue = cookieConsent ? "granted" : "denied";

    if (typeof window !== "undefined" && window.gtag) {
      window.gtag("consent", "update", {
        analytics_storage: newValue,
      });
    }
  }, [cookieConsent]);

  if (isLoading || cookieConsent !== null) {
    return null;
  }

  return (
    <div
      className={`my-10 ${cookieConsent == null ? "" : "hidden"} fixed bottom-0 left-0 right-0
        z-30 mx-auto max-w-fit sm:left-auto sm:mr-6`}>
      <div className="text-center">
        <p className="mr-3">This site uses cookies:</p>
      </div>
      <div className="flex gap-2">
        <Button variant="outline" onClick={() => setCookieConsent(false)}>
          Decline
        </Button>
        <Button onClick={() => setCookieConsent(true)}>Accept</Button>
      </div>
    </div>
  );
}
```


```ts

// lib/storageHelper.ts
'use client';

export function getLocalStorage(key: string, defaultValue: any) {
    // Get the value from local storage
    const stickyValue = localStorage.getItem(key);
    //console.log("Sticky Value read from storage: ", stickyValue)
    // Check if stickyValue is not null or undefined
    if (stickyValue !== null && stickyValue !== undefined) {
        try {
            return JSON.parse(stickyValue);
        } catch (error) {
            console.error(`Error parsing JSON for key "${key}":`, error);
            return defaultValue;
        }
    } else {
        return defaultValue;
    }
}

export function setLocalStorage(key: string, value:any){
    localStorage.setItem(key, JSON.stringify(value));
}

```

